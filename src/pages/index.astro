---
import MainHead from '../components/MainHead.astro'

const DATOCMS_ACCESS_TOKEN = "82a90d525bd1ccdc0eebf74b1d5255"
const MP_ACCESS_TOKEN = "TEST-7507661374069901-021317-f56dc83f734c864d08c1c2e32a987579-403862312"

const response = await fetch(
	'https://graphql.datocms.com/',
	{
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
			'Accept': 'application/json',
			'Authorization': `Bearer ${DATOCMS_ACCESS_TOKEN}`
		},
		body: JSON.stringify({
			query: `{
				allBooks {
					id
    				title
    				_status
    				_firstPublishedAt
  				}
			}`
		})
	}
)
const books = (await response.json()).data.allBooks
const preferences = await fetch(
	"https://api.mercadopago.com/checkout/preferences",
	{
  		method: "POST",
		headers: {
			Authorization: `Bearer ${MP_ACCESS_TOKEN}`,
			"Content-Type": "application/json"
		},
		body: JSON.stringify({
			items: [
				{
					id: "1234",
					title: "Smartphone",
					currency_id: "UYU",
					picture_url: "pics.com/sf.jpg",
					description: "Dispositivo m√≥vil",
					category_id: "art",
					quantity: 1,
					unit_price: 30000
				}
			],
			payer: {
				name: "Ricardo",
				surname: "Alvarez",
				email: "ralvarez@email.com",
				phone: {
					"area_code": "11",
					"number": "22223333"
				},
				identification: {
					"type": "DNI",
					"number": "12345678"
				},
				address: {
					"street_name": "Calle",
					"street_number": 123,
					"zip_code": "1111"
				}
			},
			back_urls: {
				success: "https://0x-g-devhayekian.vercel.app/success",
				failure: "https://0x-g-devhayekian.vercel.app/failure",
				pending: "https://0x-g-devhayekian.vercel.app/pending"
			},
			auto_return: "approved",
			payment_methods: {
				excluded_payment_methods: [
					{
						id: "amex"
					}
				],
				excluded_payment_types: [
					{
						id: "atm"
					}
				],
				installments: 1
			},
			notification_url: "https://0x-g-devhayekian.vercel.app/api/webhook",
			statement_descriptor: "Tienda eCommerce",
			external_reference: "mlplesoj9b"
		})
	})
const order = await preferences.json()
console.log(order)
---

<html lang="es">
	<head>
		<MainHead description="Jeanine White: Developer, Speaker, and Writer..." />

		<script src="https://sdk.mercadopago.com/js/v2"></script>
	</head>
	<body>
		<main>
			{books.map(book => <p>{book.title}</p>)}
		</main>
	</body>
</html>
